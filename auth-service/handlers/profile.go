package handlers

import (
	"context"
	"errors"
	"fmt"

	Authv1 "auth-service/gen/auth/v1" // generated by protoc-gen-go

	"auth-service/database" // Import the database module

	"connectrpc.com/connect"
)

// GetProfile retrieves user profile using phone number
func (s *AuthServer) GetProfile(
	ctx context.Context,
	req *connect.Request[Authv1.GetProfileRequest],
) (*connect.Response[Authv1.GetProfileResponse], error) {
	// Extract phone number from the request
	phoneNumber := req.Msg.PhoneNumber

	// Check if phone number is provided
	if phoneNumber == "" {
		return nil, errors.New("phone number is mandatory")
	}

	// Retrieve profile data from database
	profile, err := database.GetProfileByPhoneNumber(phoneNumber)
	if err != nil {
		fmt.Println("Error retrieving profile: ", err)
		return nil, err
	}

	// Create response
	res := connect.NewResponse(&Authv1.GetProfileResponse{
		PhoneNumber: profile.PhoneNumber,
		Email:       profile.Email,
		FirstName:   profile.FirstName,
		LastName:    profile.LastName,
	})
	return res, nil
}
